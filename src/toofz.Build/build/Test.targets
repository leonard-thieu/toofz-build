<Project>
  <UsingTask AssemblyFile="@(TasksAssemblyFile)" TaskName="toofz.Build.OpenCover" />
  <UsingTask AssemblyFile="@(TasksAssemblyFile)" TaskName="toofz.Build.Codecov" />

  <Target Name="Test">
    <PropertyGroup>
      <VSTestArgs>$(TargetPath)</VSTestArgs>
      <VSTestWorkingDir>$(TargetDir)</VSTestWorkingDir>
      <OpenCoverFilter>
        +[$(TargetName.Replace('.Tests', ''))]*;
        -[$(TargetName)]*
      </OpenCoverFilter>
      <CodeCoverageResultsPath>$(IntermediateOutputPath)$(TargetName).results.xml</CodeCoverageResultsPath>
    </PropertyGroup>

    <OpenCover ToolPath="$(OpenCoverToolPath)"
               Target="$(TestPlatformPath)$(VSTestToolExe)"
               TargetArgs="$(VSTestArgs)"
               TargetWorkingDir="$(VSTestWorkingDir)"
               ReturnTargetCode="true"
               Filter="$(OpenCoverFilter)"
               ExcludeByAttribute="$(OpenCoverExcludeByAttribute)"
               Output="$(CodeCoverageResultsPath)"
               OldStyle="$(OpenCoverOldStyle)">
      <Output TaskParameter="Results" ItemName="CodeCoverageResults" />
    </OpenCover>
  </Target>

  <Target Name="_PublishCoverage"
          AfterTargets="Test"
          Condition="'$(PublishCoverage)' == 'true'">
    <Codecov ToolPath="$(CodecovToolPath)"
             File="@(CodeCoverageResults)" />
  </Target>
</Project>
