<Project>
  <UsingTask AssemblyFile="@(TasksAssembly)" TaskName="toofz.Build.OpenCover" />
  <UsingTask AssemblyFile="@(TasksAssembly)" TaskName="toofz.Build.Codecov" />

  <Target Name="Test">
    <PropertyGroup>
      <VSTestArgs>$(TargetPath)</VSTestArgs>
      <VSTestWorkingDir>$(TargetDir)</VSTestWorkingDir>
      <OpenCoverFilter>
        +[$(TargetName.Replace('.Tests', ''))]*;
        -[$(TargetName)]*
      </OpenCoverFilter>
      <CodeCoverageResultsPath>$([MSBuild]::NormalizeDirectory($(ProjectDir), $(IntermediateOutputPath)))</CodeCoverageResultsPath>
      <CodeCoverageResultsFileName>$(TargetName).results.xml</CodeCoverageResultsFileName>
    </PropertyGroup>

    <OpenCover ToolPath="$(OpenCoverToolPath)"
               Target="$(TestPlatformPath)$(VSTestToolExe)"
               TargetArgs="$(VSTestArgs)"
               TargetWorkingDir="$(VSTestWorkingDir)"
               ReturnTargetCode="true"
               Filter="$(OpenCoverFilter)"
               ExcludeByAttribute="$(OpenCoverExcludeByAttribute)"
               Output="$(CodeCoverageResultsPath)$(CodeCoverageResultsFileName)"
               OldStyle="$(OpenCoverOldStyle)">
      <Output TaskParameter="Results" ItemName="CodeCoverageResults" />
    </OpenCover>
  </Target>

  <Target Name="_PublishCoverage"
          AfterTargets="Test"
          Condition="'$(PublishCoverage)' == 'true'">
    <Exec Command="git rev-parse --show-toplevel" ConsoleToMSBuild="true">
      <Output TaskParameter="ConsoleOutput" PropertyName="_GitRepoRoot" />
    </Exec>

    <Codecov ToolPath="$(CodecovToolPath)"
             RepoRoot="$([MSBuild]::NormalizeDirectory($(_GitRepoRoot)))"
             File="@(CodeCoverageResults)" />
  </Target>
</Project>
